name: Security â€” CodeQL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly scan every Monday at 9 AM UTC
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read  # needed for private repos

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        language: ['python']
        
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          
          # Enable extended security queries and quality checks
          queries: security-extended,security-and-quality
          
          # Optional: Add custom query packs for advanced detection
          # packs: |
          #   codeql/python-queries:AlertSuppression.ql
          #   codeql/python-queries:Security
          
          # Enable all built-in query suites
          config: |
            name: "Advanced Security Scan"
            
            queries:
              - uses: security-extended
              - uses: security-and-quality
            
            # Customize paths if needed
            paths-ignore:
              - '**/test/**'
              - '**/tests/**'
              - '**/node_modules/**'
              - '**/venv/**'
            
            # Enable additional experimental queries
            query-filters:
              - include:
                  kind:
                    - problem
                    - path-problem
                  tags contain:
                    - security
                    - external/cwe

      # For compiled languages, try Autobuild first (ignored for Python)
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          
          # Upload all results, even low severity
          upload: always
          
          # Don't fail on error (optional - remove if you want strict enforcement)
          # fail-on: never
